name: Documentation Quality

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.md'
      - '.github/workflows/docs-validation.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.md'
  workflow_dispatch:

jobs:
  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Markdown Lint
      uses: articulate/actions-markdownlint@v1
      with:
        config: .markdownlint.json
        files: '**.md'
        ignore: node_modules
      continue-on-error: true

    - name: Check Markdown Links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        config-file: '.markdown-link-check.json'
      continue-on-error: true

  validate-documentation:
    name: Validate Documentation Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check Required Documentation Files
      run: |
        echo "Checking for required documentation files..."
        
        required_files=(
          "README.md"
          "CONTRIBUTORS.md"
          "SECURITY.md"
          "ROADMAP.md"
          "LICENSE"
        )
        
        missing_files=0
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file is missing"
            missing_files=$((missing_files + 1))
          fi
        done
        
        if [ $missing_files -eq 0 ]; then
          echo "âœ… All required documentation files present"
        else
          echo "âŒ $missing_files required file(s) missing"
          exit 1
        fi

    - name: Validate README Structure
      run: |
        echo "Validating README.md structure..."
        
        required_sections=(
          "Overview"
          "Features"
          "Quick Start"
          "Installation"
          "Usage"
          "Contributing"
          "License"
        )
        
        missing_sections=0
        
        for section in "${required_sections[@]}"; do
          if grep -qi "$section" README.md; then
            echo "âœ… Section found: $section"
          else
            echo "âš ï¸  Section possibly missing: $section"
            missing_sections=$((missing_sections + 1))
          fi
        done
        
        if [ $missing_sections -eq 0 ]; then
          echo "âœ… README has good structure"
        else
          echo "â„¹ï¸  $missing_sections section(s) may need review (non-blocking)"
        fi

    - name: Check Documentation Spelling
      uses: rojopolis/spellcheck-github-actions@0.36.0
      with:
        config_path: .spellcheck.yml
      continue-on-error: true

    - name: Validate Code Examples in Documentation
      run: |
        echo "Checking code block formatting in markdown files..."
        
        md_files=$(find . -name "*.md" -not -path "./.git/*")
        issues=0
        
        for file in $md_files; do
          # Check for unclosed code blocks
          backticks=$(grep -c '```' "$file" || true)
          
          if [ $((backticks % 2)) -ne 0 ]; then
            echo "âš ï¸  Unclosed code block in: $file"
            issues=$((issues + 1))
          fi
        done
        
        if [ $issues -eq 0 ]; then
          echo "âœ… All code blocks properly formatted"
        else
          echo "âš ï¸  Found $issues issue(s) with code blocks"
        fi

  check-links:
    name: Check Documentation Links
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check Internal Links
      run: |
        echo "Checking internal documentation links..."
        
        # Find all markdown files
        md_files=$(find . -name "*.md" -not -path "./.git/*")
        
        broken_links=0
        
        for file in $md_files; do
          echo "Checking links in: $file"
          
          # Extract markdown links [text](path)
          links=$(grep -oP '\]\(\K[^)]+' "$file" || true)
          
          for link in $links; do
            # Skip external links (http/https)
            if [[ $link == http* ]]; then
              continue
            fi
            
            # Skip anchor links
            if [[ $link == \#* ]]; then
              continue
            fi
            
            # Check if file exists
            if [ ! -f "$link" ] && [ ! -d "$link" ]; then
              echo "âš ï¸  Broken link in $file: $link"
              broken_links=$((broken_links + 1))
            fi
          done
        done
        
        if [ $broken_links -eq 0 ]; then
          echo "âœ… All internal links are valid"
        else
          echo "âš ï¸  Found $broken_links broken link(s) (non-blocking)"
        fi

  generate-docs-report:
    name: Generate Documentation Report
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Generate Documentation Statistics
      run: |
        echo "# Documentation Statistics" > docs-report.md
        echo "" >> docs-report.md
        echo "Generated: $(date)" >> docs-report.md
        echo "" >> docs-report.md
        
        # Count documentation files
        md_count=$(find . -name "*.md" -not -path "./.git/*" | wc -l)
        echo "- Total Markdown files: $md_count" >> docs-report.md
        
        # Count total lines in documentation
        total_lines=$(find . -name "*.md" -not -path "./.git/*" -exec wc -l {} + | tail -1 | awk '{print $1}')
        echo "- Total documentation lines: $total_lines" >> docs-report.md
        
        # List main documentation files
        echo "" >> docs-report.md
        echo "## Main Documentation Files" >> docs-report.md
        echo "" >> docs-report.md
        
        for file in README.md CONTRIBUTORS.md SECURITY.md ROADMAP.md; do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file")
            echo "- $file ($lines lines)" >> docs-report.md
          fi
        done
        
        cat docs-report.md

    - name: Upload Documentation Report
      uses: actions/upload-artifact@v4
      with:
        name: docs-report
        path: docs-report.md
        retention-days: 30

  readme-metrics:
    name: README Metrics
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Analyze README
      run: |
        if [ -f "README.md" ]; then
          echo "ðŸ“Š README.md Metrics"
          echo "===================="
          
          # Line count
          lines=$(wc -l < README.md)
          echo "Lines: $lines"
          
          # Word count
          words=$(wc -w < README.md)
          echo "Words: $words"
          
          # Count headers
          headers=$(grep -c '^#' README.md || true)
          echo "Headers: $headers"
          
          # Count code blocks
          code_blocks=$(grep -c '```' README.md || true)
          code_blocks=$((code_blocks / 2))
          echo "Code blocks: $code_blocks"
          
          # Count links
          links=$(grep -o '\[.*\](.*' README.md | wc -l)
          echo "Links: $links"
          
          # Check for badges
          badges=$(grep -c '!\[.*\](http' README.md || true)
          echo "Badges: $badges"
          
          echo ""
          echo "âœ… README analysis complete"
        fi
